name: 'Terraform Destroy Infrastructure'

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction of infrastructure'
        required: true
        default: ''

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    environment: production
    
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
    # Safety check - only proceed if user typed DESTROY
    - name: Confirm Destroy
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ Destruction cancelled. You must type 'DESTROY' to confirm."
          exit 1
        fi
        echo "âœ… Destruction confirmed. Proceeding..."

    # Checkout the repository
    - name: Checkout
      uses: actions/checkout@v4

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # Login to Azure using service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Set Azure credentials as environment variables for Terraform
    - name: Set Azure Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV

    # Setup backend configuration from existing storage
    - name: Setup Backend Configuration
      run: |
        echo "ğŸ” Setting up backend configuration..."
        
        # Find existing storage account
        STORAGE_ACCOUNT=$(az storage account list --resource-group tfstate-rg --query "[?starts_with(name, 'tfstate')].name" -o tsv 2>/dev/null | head -1 || echo "")
        
        if [ -z "$STORAGE_ACCOUNT" ]; then
          echo "âŒ No backend storage found. Infrastructure may not have been created with backend."
          echo "ğŸ”„ Attempting emergency cleanup..."
          
          # Try direct Azure CLI cleanup
          if az group show --name myTFResourceGroup &>/dev/null; then
            echo "ğŸ”¥ Found myTFResourceGroup, deleting directly..."
            az group delete --name myTFResourceGroup --yes --no-wait
          fi
          
          exit 0
        fi
        
        echo "âœ… Found storage account: $STORAGE_ACCOUNT"
        
        # Create backend configuration
        cat > backend.tf << EOF
        terraform {
          backend "azurerm" {
            resource_group_name  = "tfstate-rg"
            storage_account_name = "$STORAGE_ACCOUNT"
            container_name       = "tfstate"
            key                  = "terraform.tfstate"
          }
        }
        EOF
        
        echo "Backend configuration created"

    # Initialize Terraform
    - name: Terraform Init
      run: |
        echo "ğŸ”„ Initializing Terraform with backend..."
        terraform init -input=false

    # Show what will be destroyed
    - name: Terraform Plan Destroy
      run: |
        echo "=== Resources that will be DESTROYED ==="
        terraform plan -destroy -input=false -no-color
        echo "=== End Destroy Plan ==="

    # Wait before destruction (gives time to cancel if needed)
    - name: Wait Before Destroy
      run: |
        echo "â³ Waiting 30 seconds before destruction..."
        echo "Cancel the workflow now if you changed your mind!"
        sleep 30
        echo "ğŸš¨ Starting destruction in 5 seconds..."
        sleep 5

    # Destroy infrastructure in correct order
    - name: Terraform Destroy with Proper Order
      run: |
        echo "ğŸ”¥ DESTROYING INFRASTRUCTURE IN CORRECT ORDER..."
        
        # First: Destroy main infrastructure only
        echo "1ï¸âƒ£ Destroying main infrastructure..."
        terraform destroy -auto-approve -input=false \
          -target=azurerm_virtual_network.vnet \
          -target=azurerm_resource_group.rg
        
        echo "âœ… Main infrastructure destroyed"
        
        # Second: Copy state to local before destroying backend
        echo "2ï¸âƒ£ Migrating state to local before backend destruction..."
        
        # Remove backend configuration temporarily
        mv backend.tf backend.tf.bak
        
        # Reinitialize with local backend
        terraform init -migrate-state -force-copy
        
        echo "âœ… State migrated to local"
        
        # Third: Destroy backend storage
        echo "3ï¸âƒ£ Destroying backend storage..."
        terraform destroy -auto-approve -input=false \
          -target=azurerm_storage_container.tfstate \
          -target=azurerm_storage_account.tfstate \
          -target=azurerm_resource_group.tfstate \
          -target=random_string.storage_suffix
        
        echo "âœ… Backend storage destroyed"

    # Verify destruction completed
    - name: Verify Destruction
      run: |
        echo "ğŸ” Verifying all resources are deleted..."
        
        # Wait and check for main resource group
        echo "Checking myTFResourceGroup..."
        for i in {1..10}; do
          if ! az group show --name myTFResourceGroup &>/dev/null; then
            echo "âœ… myTFResourceGroup deleted"
            break
          fi
          echo "Waiting for myTFResourceGroup deletion... ($i/10)"
          sleep 30
        done
        
        # Check for tfstate resource group
        echo "Checking tfstate-rg..."
        for i in {1..10}; do
          if ! az group show --name tfstate-rg &>/dev/null; then
            echo "âœ… tfstate-rg deleted (or never existed)"
            break
          fi
          echo "Waiting for tfstate-rg deletion... ($i/10)"
          sleep 30
        done
        
        # Final verification
        echo "ğŸ“Š Final resource check..."
        REMAINING_RGS=$(az group list --query "[?starts_with(name, 'myTF') || starts_with(name, 'tfstate')].name" -o tsv)
        
        if [ -z "$REMAINING_RGS" ]; then
          echo "ğŸ¯ SUCCESS: All resources destroyed!"
          echo "ğŸ’° No more costs will be incurred"
        else
          echo "âš ï¸ WARNING: Some resource groups still exist:"
          echo "$REMAINING_RGS"
          echo "You may need to delete them manually from Azure Portal"
        fi

    # Confirmation message
    - name: Destruction Complete
      run: |
        echo "ğŸ¯ Terraform destroy completed successfully!"
        echo "All resources have been removed from Azure."