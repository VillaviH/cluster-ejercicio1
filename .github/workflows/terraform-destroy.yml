name: 'Terraform Destroy Infrastructure'

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction of infrastructure'
        required: true
        default: ''

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    environment: production
    
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
    # Safety check - only proceed if user typed DESTROY
    - name: Confirm Destroy
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ Destruction cancelled. You must type 'DESTROY' to confirm."
          exit 1
        fi
        echo "âœ… Destruction confirmed. Proceeding..."

    # Checkout the repository
    - name: Checkout
      uses: actions/checkout@v4

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # Login to Azure using service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Set Azure credentials as environment variables for Terraform
    - name: Set Azure Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV

    # Get backend configuration from existing storage
    - name: Setup Backend Configuration
      run: |
        echo "ğŸ” Looking for existing storage account..."
        
        # Find storage account that starts with 'tfstate'
        STORAGE_ACCOUNT=$(az storage account list --resource-group tfstate-rg --query "[?starts_with(name, 'tfstate')].name" -o tsv | head -1)
        
        if [ -z "$STORAGE_ACCOUNT" ]; then
          echo "âŒ No backend storage found. Run the main workflow first to create infrastructure."
          exit 1
        fi
        
        echo "âœ… Found storage account: $STORAGE_ACCOUNT"
        
        # Create backend configuration
        cat > backend.tf << EOF
        terraform {
          backend "azurerm" {
            resource_group_name  = "tfstate-rg"
            storage_account_name = "$STORAGE_ACCOUNT"
            container_name       = "tfstate"
            key                  = "terraform.tfstate"
          }
        }
        EOF
        
        echo "Backend configuration created"

    # Initialize Terraform
    - name: Terraform Init
      run: terraform init

    # Show what will be destroyed
    - name: Terraform Plan Destroy
      run: |
        echo "=== Resources that will be DESTROYED ==="
        terraform plan -destroy -input=false -no-color
        echo "=== End Destroy Plan ==="

    # Wait before destruction (gives time to cancel if needed)
    - name: Wait Before Destroy
      run: |
        echo "â³ Waiting 30 seconds before destruction..."
        echo "Cancel the workflow now if you changed your mind!"
        sleep 30
        echo "ğŸš¨ Starting destruction in 5 seconds..."
        sleep 5

    # Destroy the infrastructure
    - name: Terraform Destroy
      run: |
        echo "ğŸ”¥ DESTROYING INFRASTRUCTURE..."
        terraform destroy -auto-approve -input=false
        echo "âœ… Infrastructure destroyed successfully"

    # Confirmation message
    - name: Destruction Complete
      run: |
        echo "ğŸ¯ Terraform destroy completed successfully!"
        echo "All resources have been removed from Azure."