name: 'Terraform Destroy Infrastructure'

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "DESTROY" to confirm destruction of infrastructure'
        required: true
        default: ''

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  destroy:
    name: 'Terraform Destroy'
    runs-on: ubuntu-latest
    environment: production
    
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
    # Safety check - only proceed if user typed DESTROY
    - name: Confirm Destroy
      run: |
        if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
          echo "âŒ Destruction cancelled. You must type 'DESTROY' to confirm."
          exit 1
        fi
        echo "âœ… Destruction confirmed. Proceeding..."

    # Checkout the repository
    - name: Checkout
      uses: actions/checkout@v4

    # Install Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # Login to Azure using service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Set Azure credentials as environment variables for Terraform
    - name: Set Azure Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV

    # Initialize Terraform
    - name: Terraform Init
      run: terraform init

    # Show what will be destroyed
    - name: Terraform Plan Destroy
      run: |
        echo "=== Resources that will be DESTROYED ==="
        terraform plan -destroy -input=false -no-color
        echo "=== End Destroy Plan ==="

    # Wait before destruction (gives time to cancel if needed)
    - name: Wait Before Destroy
      run: |
        echo "â³ Waiting 30 seconds before destruction..."
        echo "Cancel the workflow now if you changed your mind!"
        sleep 30
        echo "ğŸš¨ Starting destruction in 5 seconds..."
        sleep 5

    # Destroy the infrastructure
    - name: Terraform Destroy
      id: terraform_destroy
      run: |
        echo "ğŸ”¥ DESTROYING INFRASTRUCTURE WITH TERRAFORM..."
        
        # Capture terraform destroy output
        DESTROY_OUTPUT=$(terraform destroy -auto-approve -input=false 2>&1)
        echo "$DESTROY_OUTPUT"
        
        # Check if terraform actually destroyed something
        if echo "$DESTROY_OUTPUT" | grep -q "No changes. No objects need to be destroyed"; then
          echo "âš ï¸ Terraform found no objects to destroy, but resources may exist in Azure"
          echo "terraform_found_nothing=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… Terraform destroy completed normally"
          echo "terraform_found_nothing=false" >> $GITHUB_OUTPUT
        fi

    # Check if resources actually exist in Azure
    - name: Check Azure Resources
      id: check_resources
      run: |
        echo "ğŸ” Checking if resources actually exist in Azure..."
        
        EXISTING_RESOURCES=""
        
        # Check main resource group
        if az group show --name myTFResourceGroup &>/dev/null; then
          echo "âš ï¸ Found: myTFResourceGroup"
          EXISTING_RESOURCES="$EXISTING_RESOURCES myTFResourceGroup"
        fi
        
        # Check tfstate resource group
        if az group show --name tfstate-rg &>/dev/null; then
          echo "âš ï¸ Found: tfstate-rg"
          EXISTING_RESOURCES="$EXISTING_RESOURCES tfstate-rg"
        fi
        
        if [ -n "$EXISTING_RESOURCES" ]; then
          echo "resources_exist=true" >> $GITHUB_OUTPUT
          echo "existing_resources=$EXISTING_RESOURCES" >> $GITHUB_OUTPUT
          echo "ğŸš¨ Resources exist in Azure but Terraform doesn't know about them!"
        else
          echo "resources_exist=false" >> $GITHUB_OUTPUT
          echo "âœ… No resources found in Azure"
        fi

    # Force delete with Azure CLI if resources exist but Terraform didn't destroy them
    - name: Force Delete with Azure CLI
      if: steps.terraform_destroy.outputs.terraform_found_nothing == 'true' && steps.check_resources.outputs.resources_exist == 'true'
      run: |
        echo "ğŸš¨ TERRAFORM STATE OUT OF SYNC - USING AZURE CLI TO FORCE DELETE"
        echo "Resources to delete: ${{ steps.check_resources.outputs.existing_resources }}"
        
        # Delete main resource group
        if az group show --name myTFResourceGroup &>/dev/null; then
          echo "ğŸ”¥ Force deleting myTFResourceGroup..."
          az group delete --name myTFResourceGroup --yes --no-wait
        fi
        
        # Delete tfstate resource group
        if az group show --name tfstate-rg &>/dev/null; then
          echo "ğŸ”¥ Force deleting tfstate-rg..."
          az group delete --name tfstate-rg --yes --no-wait
        fi
        
        echo "âœ… Azure CLI deletion initiated"

    # Verify destruction completed
    - name: Verify Destruction
      run: |
        echo "ğŸ” Verifying all resources are deleted..."
        
        # Wait and check for main resource group
        echo "Checking myTFResourceGroup..."
        for i in {1..10}; do
          if ! az group show --name myTFResourceGroup &>/dev/null; then
            echo "âœ… myTFResourceGroup deleted"
            break
          fi
          echo "Waiting for myTFResourceGroup deletion... ($i/10)"
          sleep 30
        done
        
        # Check for tfstate resource group
        echo "Checking tfstate-rg..."
        for i in {1..10}; do
          if ! az group show --name tfstate-rg &>/dev/null; then
            echo "âœ… tfstate-rg deleted (or never existed)"
            break
          fi
          echo "Waiting for tfstate-rg deletion... ($i/10)"
          sleep 30
        done
        
        # Final verification
        echo "ğŸ“Š Final resource check..."
        REMAINING_RGS=$(az group list --query "[?starts_with(name, 'myTF') || starts_with(name, 'tfstate')].name" -o tsv)
        
        if [ -z "$REMAINING_RGS" ]; then
          echo "ğŸ¯ SUCCESS: All resources destroyed!"
          echo "ğŸ’° No more costs will be incurred"
        else
          echo "âš ï¸ WARNING: Some resource groups still exist:"
          echo "$REMAINING_RGS"
          echo "You may need to delete them manually from Azure Portal"
        fi

    # Confirmation message
    - name: Destruction Complete
      run: |
        echo "ğŸ¯ Terraform destroy completed successfully!"
        echo "All resources have been removed from Azure."