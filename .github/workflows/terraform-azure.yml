name: 'Terraform Azure Infrastructure'

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main
    
  workflow_dispatch:

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production
    
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
    # Debug step to check environment
    - name: Debug Environment
      run: |
        echo "=== Environment Debug ==="
        echo "Runner OS: ${{ runner.os }}"
        echo "GitHub Actor: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Working Directory: ${{ env.WORKING_DIRECTORY }}"
        echo "Current Directory: $(pwd)"
        echo "=== End Debug ==="

    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4

    # Debug step to check files
    - name: Debug Files
      run: |
        echo "=== Files Debug ==="
        ls -la
        echo "Terraform files:"
        find . -name "*.tf" -type f
        echo "=== End Files Debug ==="

    # Install the latest version of Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # Login to Azure using service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      continue-on-error: true

    # Set Azure credentials as environment variables for Terraform
    - name: Set Azure Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV

    # Initialize Terraform with smart backend handling
    - name: Terraform Init and Backend Setup
      run: |
        echo "=== Smart Backend Setup ==="
        
        # Check if backend storage already exists
        EXISTING_STORAGE=$(az storage account list --resource-group tfstate-rg --query "[?starts_with(name, 'tfstate')].name" -o tsv 2>/dev/null | head -1 || echo "")
        
        if [ -n "$EXISTING_STORAGE" ]; then
          echo "âœ… Found existing backend storage: $EXISTING_STORAGE"
          
          # Create backend configuration with existing storage
          cat > backend.tf << EOF
        terraform {
          backend "azurerm" {
            resource_group_name  = "tfstate-rg"
            storage_account_name = "$EXISTING_STORAGE"
            container_name       = "tfstate"
            key                  = "terraform.tfstate"
          }
        }
        EOF
          
          echo "ğŸ”„ Initializing with existing backend..."
          terraform init -input=false
          
        else
          echo "ğŸ†• No existing backend found, creating new one..."
          
          # First init without backend
          terraform init -input=false
          
          # Create backend storage
          echo "ğŸ“¦ Creating backend storage..."
          terraform apply -auto-approve -target=azurerm_resource_group.tfstate -target=azurerm_storage_account.tfstate -target=azurerm_storage_container.tfstate -target=random_string.storage_suffix
          
          # Get the created storage account name
          STORAGE_ACCOUNT=$(terraform output -raw storage_account_name)
          echo "âœ… Created storage account: $STORAGE_ACCOUNT"
          
          # Create backend configuration
          cat > backend.tf << EOF
        terraform {
          backend "azurerm" {
            resource_group_name  = "tfstate-rg"
            storage_account_name = "$STORAGE_ACCOUNT"
            container_name       = "tfstate"
            key                  = "terraform.tfstate"
          }
        }
        EOF
          
          echo "ğŸ”„ Migrating to remote backend..."
          terraform init -migrate-state -force-copy
        fi
        
        echo "âœ… Backend setup complete!"

    # Debug Azure login
    - name: Debug Azure Login
      run: |
        echo "=== Azure Debug ==="
        if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
          echo "WARNING: AZURE_CREDENTIALS secret is not set"
        else
          echo "AZURE_CREDENTIALS secret is configured"
          echo "Client ID: $ARM_CLIENT_ID"
          echo "Subscription ID: $ARM_SUBSCRIPTION_ID"
          echo "Tenant ID: $ARM_TENANT_ID"
        fi
        echo "=== End Azure Debug ==="

    # Initialize a new or existing Terraform working directory
    - name: Terraform Init
      run: |
        echo "=== Terraform Init Debug ==="
        terraform version
        
        # Check if backend.tf exists, if not create it
        if [ ! -f "backend.tf" ]; then
          echo "Backend configuration not found, will be created during apply"
          terraform init -input=false
        else
          echo "Using existing backend configuration"
          terraform init -input=false
        fi
        echo "=== End Terraform Init Debug ==="

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: |
        echo "=== Terraform Format Debug ==="
        terraform fmt -check -diff
        echo "=== End Terraform Format Debug ==="
      continue-on-error: true

    # Validates the configuration files in a directory
    - name: Terraform Validate
      run: |
        echo "=== Terraform Validate Debug ==="
        terraform validate
        echo "=== End Terraform Validate Debug ==="

    # Generates an execution plan for Terraform
    - name: Terraform Plan
      run: |
        echo "=== Terraform Plan Debug ==="
        terraform plan -input=false -no-color
        echo "=== End Terraform Plan Debug ==="

    # On push to "main", build or change infrastructure according to Terraform configuration files
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "=== Terraform Apply Debug ==="
        terraform apply -auto-approve -input=false
        echo "=== End Terraform Apply Debug ==="