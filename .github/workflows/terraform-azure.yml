name: 'Terraform Azure Infrastructure'

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main
    
  workflow_dispatch:

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: '.'

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production
    
    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
    # Debug step to check environment
    - name: Debug Environment
      run: |
        echo "=== Environment Debug ==="
        echo "Runner OS: ${{ runner.os }}"
        echo "GitHub Actor: ${{ github.actor }}"
        echo "Repository: ${{ github.repository }}"
        echo "Working Directory: ${{ env.WORKING_DIRECTORY }}"
        echo "Current Directory: $(pwd)"
        echo "=== End Debug ==="

    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v4

    # Debug step to check files
    - name: Debug Files
      run: |
        echo "=== Files Debug ==="
        ls -la
        echo "Terraform files:"
        find . -name "*.tf" -type f
        echo "=== End Files Debug ==="

    # Install the latest version of Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # Login to Azure using service principal
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      continue-on-error: true

    # Set Azure credentials as environment variables for Terraform
    - name: Set Azure Environment Variables
      run: |
        echo "ARM_CLIENT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}" >> $GITHUB_ENV

    # Debug Azure login
    - name: Debug Azure Login
      run: |
        echo "=== Azure Debug ==="
        if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
          echo "WARNING: AZURE_CREDENTIALS secret is not set"
        else
          echo "AZURE_CREDENTIALS secret is configured"
          echo "Client ID: $ARM_CLIENT_ID"
          echo "Subscription ID: $ARM_SUBSCRIPTION_ID"
          echo "Tenant ID: $ARM_TENANT_ID"
        fi
        echo "=== End Azure Debug ==="

    # Initialize a new or existing Terraform working directory
    - name: Terraform Init
      run: |
        echo "=== Terraform Init Debug ==="
        terraform version
        terraform init -input=false
        echo "=== End Terraform Init Debug ==="

    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: |
        echo "=== Terraform Format Debug ==="
        terraform fmt -check -diff
        echo "=== End Terraform Format Debug ==="
      continue-on-error: true

    # Validates the configuration files in a directory
    - name: Terraform Validate
      run: |
        echo "=== Terraform Validate Debug ==="
        terraform validate
        echo "=== End Terraform Validate Debug ==="

    # Generates an execution plan for Terraform
    - name: Terraform Plan
      run: |
        echo "=== Terraform Plan Debug ==="
        terraform plan -input=false -no-color
        echo "=== End Terraform Plan Debug ==="

    # On push to "main", build or change infrastructure according to Terraform configuration files
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform apply -auto-approve -input=false